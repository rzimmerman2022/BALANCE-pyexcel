# canonical_schema.yml
# Defined based on the audit_all_sources.py report from 5 source CSVs.
# This schema aims to be evidence-based and robust.

# --- METADATA COLUMNS (Generated or Inferred by Pipeline) ---
# These are essential for pipeline operation and data lineage, typically not direct from source data fields.
metadata_columns:
  - Name: TxnID
    Rationale: "Unique transaction identifier generated by the pipeline. Essential for deduplication and tracking."
  - Name: Owner
    Rationale: "Identifies the owner of the transaction (e.g., Ryan, Jordyn). Typically derived from file path or schema rules."
  - Name: DataSourceName
    Rationale: "Identifies the specific source schema/file type (e.g., jordyn_chase_v1, ryan_monarch_v2). Derived from schema."
  - Name: DataSourceDate
    Rationale: "Date the source file was processed or its modification date. Useful for data lineage."
  - Name: Extras
    Rationale: "JSON string containing unmapped columns from the source, for auditability and future use."
  - Name: Currency
    Rationale: "Transaction currency, typically 'USD'. Can be static or mapped if sources provide it."

# --- REQUIRED COLUMNS (High coverage, essential for analysis) ---
# These columns are expected to be present and well-populated across most, if not all, sources.
required_columns:
  - Name: Date
    Rationale: "Transaction date. 100% coverage in all 5 sources. Core transactional field."
    OriginalsExample: {"Chase": "Transaction Date", "Discover": "Date", "WellsFargo": "Date", "Monarch": "Date", "Rocket": "Date"}
  - Name: Amount
    Rationale: "Transaction amount. ~100% coverage in all 5 sources. Core transactional field."
    OriginalsExample: {"AllSources": "Amount"}
  - Name: OriginalDescription
    Rationale: "The most detailed raw description/memo from the source. High coverage. Chase/Discover/WF use 'Description'. Monarch uses 'Original Statement'. Rocket uses 'Description'."
    OriginalsExample: {"Chase/Discover/WF": "Description", "Monarch": "Original Statement", "Rocket": "Description"}
  - Name: Merchant
    Rationale: "Cleaned or provided merchant name. For banks, this will be derived from OriginalDescription. Aggregators (Monarch, Rocket) provide a merchant-like field."
    OriginalsExample: {"Monarch": "Merchant", "Rocket": "Name (mapped to Merchant)"}
  - Name: Account
    Rationale: "Account name or identifier. 100% coverage in 4/5 sources (Chase 'Account Type', Discover 'Card Type', WF 'Account Description', Monarch 'Account'). Rocket's 'Account Name' maps here."
    OriginalsExample: {"Chase": "Account Type", "Discover": "Card Type", "WF": "Account Description", "Monarch": "Account", "Rocket": "Account Name"}
  - Name: Category
    Rationale: "Transaction category. ~100% coverage in all 5 sources. Core for analysis."
    OriginalsExample: {"AllSources": "Category"}

# --- OPTIONAL COLUMNS (Valuable when present, but may be source-specific or less populated) ---
optional_columns:
  - Name: PostDate
    Rationale: "Posting date of the transaction. High coverage in 3/5 sources (bank/card files)."
    OriginalsExample: {"Chase/Discover/WF": "Post Date"}
  - Name: Institution
    Rationale: "Financial institution name. Present in WF, Rocket. Can be derived for Monarch. Useful for context."
    OriginalsExample: {"WellsFargo": "Institution", "Rocket": "Institution Name"}
  - Name: AccountLast4
    Rationale: "Last 4 digits of the account number. Often derivable from Account name. Useful for specific account identification."
    OriginalsExample: {"Derived from Account"}
  - Name: AccountType
    Rationale: "Type of account (e.g., Checking, Credit Card). Present in Rocket. Can be derived/standardized for others."
    OriginalsExample: {"Rocket": "Account Type"}
  - Name: ReferenceNumber
    Rationale: "Transaction reference or check number. Good coverage in 2/5 sources (Chase, WF Card)."
    OriginalsExample: {"Chase/WF": "Reference Number"}
  - Name: StatementStart
    Rationale: "Start date of the bank/card statement period. High coverage in 2/5 sources."
    OriginalsExample: {"Chase/WF": "Statement Start Date"}
  - Name: StatementEnd
    Rationale: "End date of the bank/card statement period. High coverage in 2/5 sources."
    OriginalsExample: {"Chase/WF": "Statement End Date"}
  - Name: StatementPeriodDesc
    Rationale: "Description of the statement period. High coverage in 2/5 sources."
    OriginalsExample: {"Discover": "Statement Period", "WF": "Statement Period Description"}
  - Name: Tags
    Rationale: "User-defined tags. Present in Monarch, very low population. Potentially useful for other aggregators."
    OriginalsExample: {"Monarch": "Tags"}
  - Name: OriginalDate # From Rocket Money
    Rationale: "Original transaction date if different from 'Date'. Specific to Rocket Money."
    OriginalsExample: {"Rocket": "Original Date"}
  - Name: AccountNumber # From Rocket Money
    Rationale: "Full account number if provided. Specific to Rocket Money."
    OriginalsExample: {"Rocket": "Account Number"}
  - Name: Note
    Rationale: "User-added notes for a transaction. Currently very low population (Rocket, Monarch 'Notes')."
    OriginalsExample: {"Rocket": "Note", "Monarch": "Notes (unmapped)"}
  - Name: Description
    Rationale: "Primary or shorter description. Can be directly from source (e.g., Rocket Money), or an alias of OriginalDescription (e.g., for bank files via schema rule)."
    OriginalsExample: {"Rocket": "Description (raw)", "Banks": "Alias of OriginalDescription"}
  # Consider adding other low-population but potentially useful fields from the audit as optional if they have semantic value:
  # e.g., TaxDeductible, CustomName, IgnoredFrom (from Rocket Money, very low population)
  # For now, these will likely fall into 'Extras' unless explicitly mapped.
