2025-05-22 20:20:57,117 - DEBUG - Logging configured. Level: DEBUG. Handlers: [None, None]
2025-05-22 20:20:57,117 - INFO - ==================================================
2025-05-22 20:20:57,117 - INFO - Starting BALANCE-pyexcel CLI process (full ETL mode)...
2025-05-22 20:20:57,117 - DEBUG - Arguments received (full ETL mode): inbox='C:\BALANCE\BALANCE-pyexcel-repository\CSVs\Ryan\Ryan - Rocket Money - 20250412.csv', workbook='workbook/BALANCE-pyexcel_test.xlsm'
2025-05-22 20:20:57,118 - DEBUG - Resolved Inbox Path: C:\BALANCE\BALANCE-pyexcel-repository\CSVs\Ryan\Ryan - Rocket Money - 20250412.csv
2025-05-22 20:20:57,120 - DEBUG - Resolved Workbook Path: C:\BALANCE\BALANCE-pyexcel\workbook\BALANCE-pyexcel_test.xlsm
2025-05-22 20:20:57,120 - WARNING - Target workbook does not exist: C:\BALANCE\BALANCE-pyexcel\workbook\BALANCE-pyexcel_test.xlsm. Will attempt to create it.
2025-05-22 20:20:57,120 - DEBUG - Created lock file: C:\BALANCE\BALANCE-pyexcel\workbook\BALANCE-pyexcel_test.xlsm.lock
2025-05-22 20:20:57,120 - INFO - Attempting to load specified columns from canonical Parquet: C:\BALANCE\BALANCE-pyexcel\workbook\balance_final.parquet
2025-05-22 20:20:57,149 - INFO - Loaded 1177 rows from canonical Parquet, selected columns: ['TxnID', 'SharedFlag', 'SplitPercent'].
2025-05-22 20:20:57,149 - INFO - Starting ETL process for inbox: C:\BALANCE\BALANCE-pyexcel-repository\CSVs\Ryan\Ryan - Rocket Money - 20250412.csv
2025-05-22 20:20:57,149 - INFO - Found 1 CSV files to process: ['Ryan - Rocket Money - 20250412.csv']
2025-05-22 20:20:57,149 - INFO - Loading merchant lookup rules from: C:\BALANCE\BALANCE-pyexcel\rules\merchant_lookup.csv
2025-05-22 20:20:57,151 - INFO - Successfully loaded and compiled 10 merchant lookup rules from C:\BALANCE\BALANCE-pyexcel\rules\merchant_lookup.csv.
2025-05-22 20:20:57,152 - INFO - [PROCESS_FILE_START] File: Ryan - Rocket Money - 20250412.csv
2025-05-22 20:20:57,159 - DEBUG - [SCHEMA_MATCH_INPUT] File: Ryan - Rocket Money - 20250412.csv | Headers: ['Date', 'Original Date', 'Account Type', 'Account Name', 'Account Number', 'Institution Name', 'Name', 'Custom Name', 'Amount', 'Description', 'Category', 'Note', 'Ignored From', 'Tax Deductible']
2025-05-22 20:20:57,159 - DEBUG - [PROCESS_FILE_DETAIL] File: Ryan - Rocket Money - 20250412.csv | Detail: Inferred Owner 'Ryan' from path.
2025-05-22 20:20:57,159 - DEBUG - [PROCESS_FILE_DETAIL] File: Ryan - Rocket Money - 20250412.csv | Detail: DataSourceDate set to 2025-04-25 16:53:14.255286
2025-05-22 20:20:57,159 - INFO - [SCHEMA_RESULT] File: Ryan - Rocket Money - 20250412.csv | Selected schema: ryan_rocket_v1 | Matched with missing: None, extras: None
2025-05-22 20:20:57,159 - DEBUG - [APPLY_SCHEMA_STATE] File: Ryan - Rocket Money - 20250412.csv | Schema: ryan_rocket_v1 | Stage: Before Transformations | Columns: ['Date', 'Original Date', 'Account Type', 'Account Name', 'Account Number', 'Institution Name', 'Name', 'Custom Name', 'Amount', 'Description', 'Category', 'Note', 'Ignored From', 'Tax Deductible']
2025-05-22 20:20:57,160 - DEBUG - [APPLY_SCHEMA_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Schema: ryan_rocket_v1 | Step: Column Mapping | Details: Renamed columns {'Date': 'Date', 'Original Date': 'OriginalDate', 'Account Type': 'AccountType', 'Account Name': 'AccountName', 'Account Number': 'AccountNumber', 'Institution Name': 'InstitutionName', 'Name': 'Merchant', 'Custom Name': 'CustomName', 'Amount': 'Amount', 'Description': 'Description', 'Category': 'Category', 'Note': 'Notes', 'Ignored From': 'IgnoredFrom', 'Tax Deductible': 'TaxDeductible'}
2025-05-22 20:20:57,162 - DEBUG - [APPLY_SCHEMA_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Schema: ryan_rocket_v1 | Step: Date Parsing | Column: Date | Format: %Y-%m-%d
2025-05-22 20:20:57,162 - DEBUG - [APPLY_SCHEMA_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Schema: ryan_rocket_v1 | Step: Amount ToNumeric | Column: Amount
2025-05-22 20:20:57,163 - DEBUG - [APPLY_SCHEMA_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Schema: ryan_rocket_v1 | Step: Amount Sign Rule | Column: Amount | Rule: as_is
2025-05-22 20:20:57,163 - DEBUG - [APPLY_SCHEMA_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Schema: ryan_rocket_v1 | Step: Amount Astype Float | Column: Amount
2025-05-22 20:20:57,163 - DEBUG - [APPLY_SCHEMA_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Schema: ryan_rocket_v1 | Step: Derived Column | New Column: Owner | Details: Rule Type: static_value | Value: Ryan
2025-05-22 20:20:57,163 - DEBUG - [APPLY_SCHEMA_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Schema: ryan_rocket_v1 | Step: Derived Column | New Column: DataSourceName | Details: Rule Type: static_value | Value: RocketMoney
2025-05-22 20:20:57,164 - DEBUG - [APPLY_SCHEMA_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Schema: ryan_rocket_v1 | Step: DataSourceName Population | Detail: DataSourceName already populated (likely by derived_columns), value: RocketMoney
2025-05-22 20:20:57,164 - WARNING - [APPLY_SCHEMA_INTEGRITY] File: Ryan - Rocket Money - 20250412.csv | Schema: ryan_rocket_v1 | Missing Master Columns After Transformations: ['TxnID', 'PostDate', 'OriginalDescription', 'Tags', 'Institution', 'Account', 'AccountLast4', 'SharedFlag', 'SplitPercent', 'StatementStart', 'StatementEnd', 'StatementPeriodDesc', 'DataSourceDate', 'ReferenceNumber', 'Note', 'Currency', 'Source']
2025-05-22 20:20:57,164 - WARNING - [APPLY_SCHEMA_INTEGRITY] File: Ryan - Rocket Money - 20250412.csv | Schema: ryan_rocket_v1 | Unexpected columns survived mapping: ['OriginalDate', 'AccountName', 'AccountNumber', 'InstitutionName', 'Notes']
2025-05-22 20:20:57,164 - DEBUG - [APPLY_SCHEMA_STATE] File: Ryan - Rocket Money - 20250412.csv | Schema: ryan_rocket_v1 | Stage: After Transformations | Columns: ['Date', 'OriginalDate', 'AccountType', 'AccountName', 'AccountNumber', 'InstitutionName', 'Merchant', 'CustomName', 'Amount', 'Description', 'Category', 'Notes', 'IgnoredFrom', 'TaxDeductible', 'Extras', 'Owner', 'DataSourceName']
2025-05-22 20:20:57,164 - DEBUG - [PROCESS_FILE_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Step: Populate Owner | Value: Ryan
2025-05-22 20:20:57,164 - DEBUG - [PROCESS_FILE_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Step: Populate DataSourceDate | Value: 2025-04-25 16:53:14.255286
2025-05-22 20:20:57,191 - DEBUG - [PROCESS_FILE_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Step: Final Merchant Cleaning
2025-05-22 20:20:57,192 - INFO - [PROCESS_FILE_STATS] File: Ryan - Rocket Money - 20250412.csv | Stat: Merchant blanks after clean: 0 (0.00%)
2025-05-22 20:20:57,221 - DEBUG - [PROCESS_FILE_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Step: TxnID Generation
2025-05-22 20:20:57,221 - DEBUG - [PROCESS_FILE_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Step: Populate Default Master Fields (Currency, SharedFlag, etc.)
2025-05-22 20:20:57,222 - DEBUG - [PROCESS_FILE_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Step: Ensure Master Columns | Added missing master columns: ['PostDate', 'OriginalDescription', 'Tags', 'Institution', 'Account', 'AccountLast4', 'StatementStart', 'StatementEnd', 'StatementPeriodDesc', 'ReferenceNumber', 'Note', 'Source']
2025-05-22 20:20:57,222 - DEBUG - [PROCESS_FILE_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Step: Data Type Coercion for Master Schema
2025-05-22 20:20:57,243 - DEBUG - [PROCESS_FILE_TRANSFORM] File: Ryan - Rocket Money - 20250412.csv | Step: Reindex to Master Schema Columns
2025-05-22 20:20:57,244 - INFO - [PROCESS_FILE_END] File: Ryan - Rocket Money - 20250412.csv | Status: Success | Rows processed: 2939
2025-05-22 20:20:57,244 - INFO - [PROCESS_SUMMARY] Schema matching counts: Counter({'ryan_rocket_v1': 1})
2025-05-22 20:20:57,244 - INFO - [PROCESS_SUMMARY] Consolidated 1 CSV files into DataFrame with 2939 total rows.
2025-05-22 20:20:57,245 - INFO - [PROCESS_SUMMARY_STATS] Total merchant blanks in final_df: 0 (0.00%)
2025-05-22 20:20:57,245 - DEBUG - [PROCESS_SUMMARY] Sorting final DataFrame.
2025-05-22 20:20:57,246 - INFO - [PROCESS_SUMMARY] Applying defensive data type management for Power BI compatibility.
2025-05-22 20:20:57,247 - DEBUG - Cast non-numeric, non-boolean column 'TxnID' to string type
2025-05-22 20:20:57,247 - DEBUG - Cast non-numeric, non-boolean column 'Owner' to string type
2025-05-22 20:20:57,247 - DEBUG - Set all-NA non-boolean column 'Date' to empty strings
2025-05-22 20:20:57,247 - DEBUG - Set all-NA non-boolean column 'PostDate' to empty strings
2025-05-22 20:20:57,248 - DEBUG - Cast non-numeric, non-boolean column 'Merchant' to string type
2025-05-22 20:20:57,248 - DEBUG - Cast non-numeric, non-boolean column 'OriginalDescription' to string type
2025-05-22 20:20:57,248 - DEBUG - Cast non-numeric, non-boolean column 'Category' to string type
2025-05-22 20:20:57,248 - DEBUG - Cast non-numeric, non-boolean column 'Tags' to string type
2025-05-22 20:20:57,249 - DEBUG - Cast non-numeric, non-boolean column 'Institution' to string type
2025-05-22 20:20:57,249 - DEBUG - Cast non-numeric, non-boolean column 'Account' to string type
2025-05-22 20:20:57,249 - DEBUG - Cast non-numeric, non-boolean column 'AccountLast4' to string type
2025-05-22 20:20:57,250 - DEBUG - Cast non-numeric, non-boolean column 'AccountType' to string type
2025-05-22 20:20:57,250 - DEBUG - Set all-NA non-boolean column 'SplitPercent' to empty strings
2025-05-22 20:20:57,250 - DEBUG - Set all-NA non-boolean column 'StatementStart' to empty strings
2025-05-22 20:20:57,250 - DEBUG - Set all-NA non-boolean column 'StatementEnd' to empty strings
2025-05-22 20:20:57,251 - DEBUG - Cast non-numeric, non-boolean column 'StatementPeriodDesc' to string type
2025-05-22 20:20:57,251 - DEBUG - Cast non-numeric, non-boolean column 'DataSourceName' to string type
2025-05-22 20:20:57,253 - DEBUG - Cast non-numeric, non-boolean column 'DataSourceDate' to string type
2025-05-22 20:20:57,254 - DEBUG - Cast non-numeric, non-boolean column 'ReferenceNumber' to string type
2025-05-22 20:20:57,254 - DEBUG - Cast non-numeric, non-boolean column 'Note' to string type
2025-05-22 20:20:57,254 - DEBUG - Cast non-numeric, non-boolean column 'IgnoredFrom' to string type
2025-05-22 20:20:57,255 - DEBUG - Set all-NA non-boolean column 'CustomName' to empty strings
2025-05-22 20:20:57,255 - DEBUG - Cast non-numeric, non-boolean column 'Currency' to string type
2025-05-22 20:20:57,255 - DEBUG - Cast non-numeric, non-boolean column 'Extras' to string type
2025-05-22 20:20:57,256 - DEBUG - Cast non-numeric, non-boolean column 'Description' to string type
2025-05-22 20:20:57,256 - DEBUG - Set all-NA non-boolean column 'Source' to empty strings
2025-05-22 20:20:57,256 - INFO - Consolidated data from CSVs into 2939 rows before deduplication.
2025-05-22 20:20:57,256 - INFO - Applying deduplication, preferring source: 'Rocket'
2025-05-22 20:20:57,259 - INFO - Found 757 sets of potential duplicate entries based on TxnID before deduplication by preferred source ('Rocket').
2025-05-22 20:20:57,261 - INFO - Removed 1227 duplicate transactions, prioritizing 'Rocket'.
2025-05-22 20:20:57,261 - INFO - Final ETL DataFrame contains 1712 rows.
2025-05-22 20:20:57,261 - INFO - Merging existing classifications from canonical data into current ETL data...
2025-05-22 20:20:57,265 - DEBUG - SplitPercent dtype before astype: object. Coercing to float.
2025-05-22 20:20:57,266 - INFO - Merged existing classifications. DataFrame now has 1712 rows.
2025-05-22 20:20:57,266 - INFO - Workbook 'BALANCE-pyexcel_test.xlsm' does not exist yet. Skipping Queue_Review read.
2025-05-22 20:20:57,266 - INFO - ⚙️  Final DF columns (29): ['TxnID', 'Owner', 'Date', 'PostDate', 'Merchant', 'OriginalDescription', 'Category', 'Amount', 'Tags', 'Institution', 'Account', 'AccountLast4', 'AccountType', 'SharedFlag', 'SplitPercent', 'StatementStart', 'StatementEnd', 'StatementPeriodDesc', 'DataSourceName', 'DataSourceDate', 'ReferenceNumber', 'Note', 'IgnoredFrom', 'TaxDeductible', 'CustomName', 'Currency', 'Extras', 'Description', 'Source']
2025-05-22 20:20:57,266 - INFO - Writing final DataFrame (1712 rows) to Parquet: C:\BALANCE\BALANCE-pyexcel\workbook\balance_final.parquet (Engine: pyarrow, Compression: zstd)
2025-05-22 20:20:57,274 - INFO - Successfully wrote Parquet file on attempt 1/5.
2025-05-22 20:20:57,274 - WARNING - Working with macro-enabled workbook (.xlsm). Using temporary file workaround.
2025-05-22 20:20:57,274 - INFO - Preparing to write output to: C:\BALANCE\BALANCE-pyexcel\workbook\BALANCE-pyexcel_test.temp.xlsx
2025-05-22 20:20:57,374 - INFO - Writing 1712 rows to 'Transactions' sheet...
2025-05-22 20:20:57,540 - DEBUG - Attempting to create 'Queue_Review' template...
2025-05-22 20:20:57,544 - DEBUG - Found 10 sample rows needing review (SharedFlag is '?' or NA) for template.
2025-05-22 20:20:57,547 - INFO - Created 'Queue_Review' template sheet (with 10 sample rows).
2025-05-22 20:20:57,780 - INFO - ✅ Wrote data to temporary XLSX file: BALANCE-pyexcel_test.temp.xlsx
2025-05-22 20:20:57,780 - INFO - 
==================================================================
2025-05-22 20:20:57,780 - INFO - IMPORTANT: To update your macro-enabled workbook:
2025-05-22 20:20:57,780 - INFO - 1. Ensure your main workbook is CLOSED: C:\BALANCE\BALANCE-pyexcel\workbook\BALANCE-pyexcel_test.xlsm
2025-05-22 20:20:57,780 - INFO - 2. Open the temporary file: C:\BALANCE\BALANCE-pyexcel\workbook\BALANCE-pyexcel_test.temp.xlsx
2025-05-22 20:20:57,780 - INFO - 3. Open your main workbook: C:\BALANCE\BALANCE-pyexcel\workbook\BALANCE-pyexcel_test.xlsm
2025-05-22 20:20:57,781 - INFO - 4. In the temporary file, right-click the 'Transactions' sheet tab -> Move or Copy...
2025-05-22 20:20:57,781 - INFO - 5. In the dialog, select 'BALANCE-pyexcel_test.xlsm' in 'To book:', check 'Create a copy', click OK.
2025-05-22 20:20:57,781 - INFO - 6. Repeat steps 4-5 for the 'Queue_Review' sheet.
2025-05-22 20:20:57,781 - INFO - 7. Close the temporary file WITHOUT saving.
2025-05-22 20:20:57,781 - INFO - 8. Save your main workbook.
2025-05-22 20:20:57,781 - INFO - 9. You can now delete the temporary file: C:\BALANCE\BALANCE-pyexcel\workbook\BALANCE-pyexcel_test.temp.xlsx
2025-05-22 20:20:57,781 - INFO -    (Or use the 'ImportFromTempFile' macro in Excel if available)
2025-05-22 20:20:57,781 - INFO - ==================================================================

2025-05-22 20:20:57,781 - INFO - ✅ Process completed successfully
2025-05-22 20:20:57,781 - DEBUG - Removed lock file: C:\BALANCE\BALANCE-pyexcel\workbook\BALANCE-pyexcel_test.xlsm.lock
